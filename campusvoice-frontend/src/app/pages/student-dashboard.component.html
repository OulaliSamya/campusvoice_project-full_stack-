<section class="student-layout">
  <!-- SIDEBAR -->
  <aside class="sidebar">
    <h2 class="app-title">CampusVoice</h2>

    <p class="user-info">
      Connect√© :
      <br />
      <strong>{{ user?.fullName || '√âtudiant' }}</strong>
      <br />
      <span class="role-label">R√¥le : STUDENT</span>
    </p>

    <nav class="menu">
      <button
        type="button"
        [class.active]="selectedSection === 'courses'"
        (click)="selectSection('courses')">
        üìö Mes modules & cours
      </button>

      <button
        type="button"
        [class.active]="selectedSection === 'feedback-course'"
        (click)="selectSection('feedback-course')">
        üìù Feedback cours / prof
      </button>

      <button
        type="button"
        [class.active]="selectedSection === 'feedback-infra'"
        (click)="selectSection('feedback-infra')">
        üè´ Feedback infrastructure
      </button>

      <button
        type="button"
        [class.active]="selectedSection === 'history'"
        (click)="selectSection('history')">
        üìÑ Historique de mes feedbacks
      </button>
    </nav>
  </aside>

  <!-- CONTENU PRINCIPAL -->
  <main class="content">

    <!-- Section : Mes modules & cours -->
    <section *ngIf="selectedSection === 'courses'" class="card">
      <h2>Mes modules & cours</h2>

      <p *ngIf="courses.length === 0">
        Aucun cours trouv√© pour le moment.
      </p>

      <div *ngIf="courses.length > 0" class="course-list">
        <div class="course-item" *ngFor="let c of courses">
          <h3>{{ c.code }} ‚Äî {{ c.title }}</h3>
          <p><strong>D√©partement :</strong> {{ c.department }}</p>
          <p *ngIf="c.teacherName">
            <strong>Enseignant :</strong> {{ c.teacherName }}
          </p>

          <!-- ‚úÖ Section documents -->
          <div *ngIf="c.documents && c.documents.length > 0" class="documents-section">
            <h4>üìö Documents du cours</h4>
            <ul class="document-list">
              <li *ngFor="let doc of c.documents">
                <a 
                  [href]="'http://localhost:8080/api/documents/download/' + doc.fileName" 
                  target="_blank"
                  class="document-link">
                  {{ doc.title }}
                </a>
                <small class="upload-date">({{ doc.uploadDate | date:'short' }})</small>
              </li>
            </ul>
          </div>
          <p *ngIf="!c.documents || c.documents.length === 0" class="no-docs">
            Aucun document disponible pour ce cours.
          </p>
        </div>
      </div>
    </section>

    <!-- Section : Feedback cours / prof -->
    <section *ngIf="selectedSection === 'feedback-course'" class="card">
      <h2>Feedback sur un cours / enseignant</h2>

      <form (ngSubmit)="sendCourseFeedback()">
        <label>
          Cours concern√©
          <select
            [(ngModel)]="selectedCourseId"
            name="selectedCourseId"
            required>
            <option [ngValue]="null">-- S√©lectionnez un cours --</option>
            <option *ngFor="let c of courses" [ngValue]="c.id">
              {{ c.code }} ‚Äî {{ c.title }}
              <span *ngIf="c.teacherName"> ({{ c.teacherName }})</span>
            </option>
          </select>
        </label>

        <label>
          Votre feedback
          <textarea
            [(ngModel)]="courseFeedbackContent"
            name="courseFeedbackContent"
            required
            placeholder="Ex : Le cours est clair mais la salle est trop petite..."
          ></textarea>
        </label>

        <div class="checkbox-group">
          <input
            type="checkbox"
            id="courseAnonymous"
            [(ngModel)]="courseFeedbackAnonymous"
            name="courseFeedbackAnonymous"
          />
          <label for="courseAnonymous">Envoyer en mode anonyme</label>
        </div>

        <button type="submit" [disabled]="sendingCourse">
          {{ sendingCourse ? 'Envoi en cours...' : 'Envoyer le feedback cours' }}
        </button>

        <p *ngIf="courseError" class="error">{{ courseError }}</p>
        <p *ngIf="courseSuccess" class="success">{{ courseSuccess }}</p>
      </form>
    </section>

    <!-- Section : Feedback infrastructure -->
    <section *ngIf="selectedSection === 'feedback-infra'" class="card">
      <h2>Feedback infrastructure</h2>

      <form (ngSubmit)="sendInfraFeedback()">
        <label>
          D√©partement / zone
          <select
            [(ngModel)]="infraDepartment"
            name="infraDepartment">
            <option *ngFor="let d of infraDepartments" [value]="d">
              {{ d }}
            </option>
          </select>
        </label>

        <label>
          Type d'infrastructure
          <select
            [(ngModel)]="infraType"
            name="infraType">
            <option *ngFor="let t of infraTypes" [value]="t">
              {{ t }}
            </option>
          </select>
        </label>

        <label>
          Votre feedback
          <textarea
            [(ngModel)]="infraContent"
            name="infraContent"
            required
            placeholder="Ex : La salle de TP 3 n‚Äôa pas de Wi-Fi fonctionnel..."
          ></textarea>
        </label>

        <div class="checkbox-group">
          <input
            type="checkbox"
            id="infraAnonymous"
            [(ngModel)]="infraAnonymous"
            name="infraAnonymous"
          />
          <label for="infraAnonymous">Envoyer en mode anonyme</label>
        </div>

        <button type="submit" [disabled]="sendingInfra">
          {{ sendingInfra ? 'Envoi en cours...' : 'Envoyer le feedback infra' }}
        </button>

        <p *ngIf="infraError" class="error">{{ infraError }}</p>
        <p *ngIf="infraSuccess" class="success">{{ infraSuccess }}</p>
      </form>
    </section>

    <!-- Section : Historique des feedbacks -->
    <section *ngIf="selectedSection === 'history'" class="card">
      <h2>Historique de mes feedbacks</h2>

      <p *ngIf="feedbackList.length === 0">
        Vous n‚Äôavez pas encore envoy√© de feedback.
      </p>

      <div *ngIf="feedbackList.length > 0" class="feedback-list">
        <div class="feedback-item" *ngFor="let fb of feedbackList">
          <!-- Mode √©dition -->
          <div *ngIf="editingFeedbackId === fb.id" class="edit-mode">
            <textarea
              [(ngModel)]="editingContent"
              placeholder="Modifiez votre feedback"
              rows="3"></textarea>
            <div class="edit-actions">
              <button type="button" (click)="saveEdit(fb.id!)">‚úÖ Enregistrer</button>
              <button type="button" (click)="cancelEditing()">‚ùå Annuler</button>
            </div>
          </div>

          <!-- Mode lecture -->
          <div *ngIf="editingFeedbackId !== fb.id">
            <div class="feedback-header">
              <span class="badge">{{ fb.category }}</span>
              <span class="date">
                {{ fb.createdAt | date: 'short' }}
                <span *ngIf="fb.updatedAt"> (modifi√© le {{ fb.updatedAt | date: 'short' }})</span>
              </span>
              <div class="action-buttons">
                <button 
                  type="button" 
                  class="edit-btn"
                  (click)="startEditing(fb)">
                  ‚úèÔ∏è
                </button>
                <button 
                  type="button" 
                  class="delete-btn"
                  (click)="deleteFeedback(fb.id!)">
                  üóëÔ∏è
                </button>
              </div>
            </div>

            <p>{{ fb.content }}</p>

            <small class="meta">
              <span *ngIf="fb.anonymous">Envoy√© en anonyme</span>
              <span *ngIf="!fb.anonymous">Envoy√© avec votre nom</span>
            </small>
          </div>
        </div>
      </div>
    </section>
  </main>
</section>